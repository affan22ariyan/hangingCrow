
<!doctype html>
<html>
<head><meta charset="utf-8"><title>All-in-One Betting System</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:20px}button{margin:4px;padding:6px 10px}
.panel{border:1px solid #ccc;padding:12px;margin:8px 0;border-radius:6px}
</style>
</head>
<body>
<h1>All-in-One Betting System (Single-file demo UI)</h1>
<p>Use this demo UI to operate Owner / B2C SubAdmin / Agent / User actions.</p>

<div class="panel">
  <h3>Register</h3>
  <form id="reg">
    Username: <input name="username" required> Password: <input name="password" required>
    Role: <select name="role"><option>user</option><option>affiliate</option><option>master_agent</option><option>b2c_subadmin</option></select>
    Ref: <input name="ref"> <button>Register</button>
  </form>
  <pre id="regOut"></pre>
</div>

<div class="panel">
  <h3>Login</h3>
  <form id="login">
    Username: <input name="username" required> Password: <input name="password" required>
    <button>Login</button>
  </form>
  <pre id="loginOut"></pre>
</div>

<div id="userArea" class="panel" style="display:none">
  <h3>User Area</h3>
  <p>ID: <span id="uid"></span> Role: <span id="urole"></span></p>
  <p>Balance: <span id="ubal">0</span> Turnover: <span id="uturn">0</span></p>
  <form id="deposit"><input name="amount" placeholder="amount" required> <button>Deposit</button></form>
  <form id="bet"><input name="stake" placeholder="stake" required> <input name="price" placeholder="price" required> <button>Place Bet</button></form>
  <button id="inviteBtn">Generate Invite Link (agent)</button>
  <pre id="userOut"></pre>
</div>

<div class="panel">
  <h3>Admin Panels</h3>
  <button onclick="loadUsers()">Load Users</button>
  <button onclick="loadCommissionLogs()">Load Commission Logs</button>
  <div style="margin-top:8px">
    <form id="setCfg">
      SubAdmin ID: <input name="sub" required> Type: <select name="type"><option>deposit</option><option>refer</option><option>turnover</option><option>weekly_loss</option><option>regular_deposit</option></select>
      Percent: <input name="percent" required> <button>Save Config</button>
    </form>
  </div>
  <pre id="adminOut"></pre>
</div>

<script>
const api = location.protocol === 'file:' ? 'http://localhost:4001' : window.location.origin.replace(/:.*$/,'') + ':4001';

function getToken() { return localStorage.getItem('token'); }
async function apiFetch(path, opts = {}) {
  const headers = opts.headers || {};
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  const token = getToken();
  if (token) headers['Authorization'] = 'Bearer ' + token;
  opts.headers = headers;
  const res = await fetch(api + path, opts);
  return res;
}

document.getElementById('reg').onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = { username: fd.get('username'), password: fd.get('password'), role: fd.get('role'), ref: fd.get('ref') || undefined };
  const res = await apiFetch('/api/auth/register', { method:'POST', body: JSON.stringify(body)});
  document.getElementById('regOut').textContent = await res.text();
};

document.getElementById('login').onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await apiFetch('/api/auth/login', { method:'POST', body: JSON.stringify({ username: fd.get('username'), password: fd.get('password') })});
  const data = await res.json();
  document.getElementById('loginOut').textContent = JSON.stringify(data, null,2);
  if (data.success) {
    localStorage.setItem('token', data.token);
    window.currentUser = data.user;
    document.getElementById('userArea').style.display = 'block';
    document.getElementById('uid').textContent = data.user.id;
    document.getElementById('urole').textContent = data.user.role;
    document.getElementById('ubal').textContent = data.user.ewallet_balance;
    document.getElementById('uturn').textContent = data.user.turnover || 0;
  }
};

document.getElementById('deposit').onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await apiFetch('/api/wallet/deposit', { method:'POST', body: JSON.stringify({ user_id: window.currentUser.id, amount: Number(fd.get('amount')) })});
  const data = await res.json();
  document.getElementById('userOut').textContent = JSON.stringify(data, null,2);
  if (data.success) {
    document.getElementById('ubal').textContent = (Number(document.getElementById('ubal').textContent) + Number(fd.get('amount'))).toFixed(2);
  }
};

document.getElementById('bet').onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await apiFetch('/api/bet/place', { method:'POST', body: JSON.stringify({ user_id: window.currentUser.id, stake: Number(fd.get('stake')), price: Number(fd.get('price')) })});
  document.getElementById('userOut').textContent = await res.text();
};

document.getElementById('inviteBtn').onclick = async ()=> {
  const agent_id = window.currentUser.id;
  const res = await apiFetch('/api/agent/invite', { method:'POST', body: JSON.stringify({ agent_id })});
  document.getElementById('userOut').textContent = await res.text();
};

document.getElementById('setCfg').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = { owner_subadmin_id: fd.get('sub'), type: fd.get('type'), percent: Number(fd.get('percent')) };
  const res = await apiFetch('/api/admin/commissions', { method:'POST', body: JSON.stringify(body)});
  document.getElementById('adminOut').textContent = await res.text();
};

async function loadUsers(){
  const res = await apiFetch('/api/admin/users');
  document.getElementById('adminOut').textContent = await res.text();
}
async function loadCommissionLogs(){
  const res = await apiFetch('/api/admin/commission-logs');
  document.getElementById('adminOut').textContent = await res.text();
}
</script>
</body>
</html>
